# Copyright (C) 2021 Anthony Harrison
# SPDX-License-Identifier: GPL-3.0-or-later

import json
import xml.etree.ElementTree as ET


class CycloneParser:
    def __init__(self):
        pass

    def parse(self, sbomfile):
        """parses CycloneDX BOM file extracting package name and version"""
        # Supported cyclonedx_type = [".json", ".xml"]
        if sbomfile.endswith("json"):
            return self.parse_cyclonedx_json(sbomfile)
        elif sbomfile.endswith(".xml"):
            return self.parse_cyclonedx_xml(sbomfile)
        else:
            return []

    def parse_cyclonedx_json(self, sbomfile):
        """parses CycloneDX JSON BOM file extracting package name and version"""
        data = json.load(open(sbomfile))
        modules = []
        for d in data["components"]:
            if d["type"] == "library":
                package = d["name"]
                version = d["version"]
                modules.append(self.save_module(package, version))

        return modules

    def parse_cyclonedx_xml(self, sbomfile):
        """parses CycloneDX XML BOM file extracting package name and version"""

        tree = ET.parse(sbomfile)
        # Find root element
        root = tree.getroot()
        # Extract schema
        schema = root.tag[: root.tag.find("}") + 1]
        # schema = '{http://cyclonedx.org/schema/bom/1.3}'

        modules = []
        for components in root.findall(schema + "components"):
            for component in components.findall(schema + "component"):
                # Only if library....
                if component.attrib["type"] == "library":
                    package = component.find(schema + "name").text
                    version = component.find(schema + "version").text
                    modules.append(self.save_module(package, version))

        return modules

    def save_module(self, package, version):
        return [package, version]


if __name__ == "__main__":
    import sys

    cyclone = CycloneParser()
    file = sys.argv[1]
    # cyclone.parse_cyclonedx_json(file)
    cyclone.parse_cyclonedx_xml(file)
    print("And again....")
    # Should get same results....
    cyclone.parse(file)
